version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: chat-api-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: chat_db
    ports:
      - "27019:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/chat_db --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Chat API
  chat-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: chat-api
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      # Application
      APP_NAME: "Chat API"
      ENVIRONMENT: "development"  # Change to 'production' for prod deployment
      DEBUG: "false"

      # Logging (Critical for debugging!)
      LOG_LEVEL: "INFO"  # DEBUG | INFO | WARNING | ERROR | CRITICAL
      LOG_JSON_FORMAT: "true"  # Always true in Docker for log aggregation
      LOG_SQL_QUERIES: "false"

      # Database
      MONGODB_URL: "mongodb://mongodb:27017"
      DATABASE_NAME: "chat_db"

      # JWT (MUST match auth-api settings!)
      JWT_SECRET: "${JWT_SECRET:-dev-secret-key-change-in-production}"
      JWT_ALGORITHM: "HS256"

      # CORS
      CORS_ORIGINS: '["http://localhost:3000","http://localhost:8000"]'

    depends_on:
      mongodb:
        condition: service_healthy

    # Network configuration - join observability stack
    networks:
      - default
      - activity-observability

    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logging configuration for Docker + Loki collection
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"

    # Observability stack labels - auto-discovery for Prometheus & Loki
    labels:
      # Service identification
      service: "chat-api"
      environment: "development"

      # Prometheus scraping configuration
      prometheus.scrape: "true"
      prometheus.port: "8001"
      prometheus.path: "/metrics"

      # Loki log collection
      loki.collect: "true"

volumes:
  mongodb_data:
    driver: local

# Networks
networks:
  # Default network for internal services (MongoDB, etc.)
  default:
    driver: bridge

  # External observability stack network
  activity-observability:
    external: true
    name: activity-observability

# Production deployment notes:
#
# 1. Use environment-specific .env files:
#    docker-compose --env-file .env.production up -d
#
# 2. For debugging, set LOG_LEVEL=DEBUG:
#    docker-compose up chat-api -e LOG_LEVEL=DEBUG
#
# 3. View logs with correlation IDs:
#    docker logs -f chat-api | grep "correlation_id"
#
# 4. View only errors:
#    docker logs -f chat-api | grep '"level":"error"'
#
# 5. For log aggregation (ELK, Datadog, etc.), logs are already in JSON format
