{
  "openapi": "3.1.0",
  "info": {
    "title": "Activity Platform - Real-time Chat API",
    "description": "\n**Real-time chat API built with FastAPI, MongoDB, and WebSocket support.**\n\nFeatures JWT authentication (shared secret with auth-api), group-based authorization, and production-grade structured logging with correlation IDs.\n\n## Key Features\n- **WebSocket Real-time Communication**: Live message broadcasting to all group members\n- **Group-based Authorization**: Fine-grained access control per chat group\n- **Soft Deletes**: Messages never permanently deleted (audit trail preserved)\n- **OAuth 2.0 Integration**: HS256 JWT validation with shared secret from auth-api\n- **Structured Logging**: JSON logging with correlation IDs for request tracing\n- **Circuit Breaker**: Resilient authorization service communication\n\n## Architecture\n- **Database**: MongoDB with Beanie ODM for document modeling\n- **Cache**: Optional Redis for authorization caching (5min TTL)\n- **WebSocket**: In-memory connection pooling with automatic cleanup\n- **Authentication**: JWT tokens issued by auth-api (shared JWT_SECRET_KEY)\n- **Observability**: Prometheus metrics, structured logging, real-time dashboard\n\n## Security\n- JWT Bearer authentication required for all endpoints\n- Group authorization checks on every message operation\n- Circuit breaker with fail-closed security (denies access on auth service failure)\n- Correlation ID tracking for security auditing\n    ",
    "version": "1.0.0"
  },
  "paths": {
    "/metrics": {
      "get": {
        "summary": "Metrics",
        "description": "Endpoint that serves Prometheus metrics.",
        "operationId": "metrics_metrics_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {}
              }
            }
          }
        }
      }
    },
    "/api/chat/groups/{group_id}/messages": {
      "post": {
        "tags": [
          "messages"
        ],
        "summary": "Create Message",
        "description": "Create a new message in a group.\n\nMulti-Tenant Security:\n- Validates group.org_id == token.org_id (via ChatService)\n- Validates user is member of group (via GroupService)\n- Message stored with org_id for tenant isolation\n\nRequires OAuth scope: chat:write",
        "operationId": "create_message_api_chat_groups__group_id__messages_post",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "group_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "title": "Group Id"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/MessageCreate"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MessageResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      },
      "get": {
        "tags": [
          "messages"
        ],
        "summary": "Get Messages",
        "description": "Get paginated message history for a group.\n\nMulti-Tenant Security:\n- Validates group.org_id == token.org_id (via ChatService)\n- Filters messages by org_id (MongoDB compound index)\n- Only returns messages from user's organization\n\nRequires OAuth scope: chat:read",
        "operationId": "get_messages_api_chat_groups__group_id__messages_get",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "group_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "title": "Group Id"
            }
          },
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "description": "Page number",
              "default": 1,
              "title": "Page"
            },
            "description": "Page number"
          },
          {
            "name": "page_size",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "maximum": 100,
              "minimum": 1,
              "description": "Messages per page",
              "default": 50,
              "title": "Page Size"
            },
            "description": "Messages per page"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MessageListResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/api/chat/messages/{message_id}": {
      "put": {
        "tags": [
          "messages"
        ],
        "summary": "Update Message",
        "description": "Update an existing message (only by sender).\n\nMulti-Tenant Security:\n- Validates message.org_id == token.org_id (via ChatService)\n- Validates message.sender_id == token.user_id (ownership)\n- Prevents cross-org message updates\n\nRequires OAuth scope: chat:write",
        "operationId": "update_message_api_chat_messages__message_id__put",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "message_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "title": "Message Id"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/MessageUpdate"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MessageResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": [
          "messages"
        ],
        "summary": "Delete Message",
        "description": "Delete a message (soft delete, only by sender).\n\nMulti-Tenant Security:\n- Validates message.org_id == token.org_id (via ChatService)\n- Validates message.sender_id == token.user_id (ownership)\n- Prevents cross-org message deletions\n\nRequires OAuth scope: chat:write",
        "operationId": "delete_message_api_chat_messages__message_id__delete",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "message_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "title": "Message Id"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Successful Response"
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/dashboard/api/data": {
      "get": {
        "tags": [
          "dashboard"
        ],
        "summary": "Get Dashboard Data",
        "description": "Get comprehensive dashboard metrics as JSON.\n\nReturns:\n    Dashboard data including:\n    - System health (API, MongoDB, uptime, resources)\n    - Database statistics (groups, messages, top active groups)\n    - WebSocket metrics (active connections, per-group breakdown)\n    - Performance metrics (response times, error rates, slow requests)\n    - Endpoint statistics (request counts, error rates per endpoint)\n    - Recent activity (requests, errors, WebSocket events)\n\nExample:\n    curl http://localhost:8001/dashboard/api/data",
        "operationId": "get_dashboard_data_dashboard_api_data_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {}
              }
            }
          }
        }
      }
    },
    "/dashboard": {
      "get": {
        "tags": [
          "dashboard"
        ],
        "summary": "Get Dashboard Html",
        "description": "Serve the dashboard HTML interface.\n\nReturns:\n    HTML page with real-time dashboard display and auto-refresh.",
        "operationId": "get_dashboard_html_dashboard_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "text/html": {
                "schema": {
                  "type": "string"
                }
              }
            }
          }
        }
      }
    },
    "/test-chat": {
      "get": {
        "tags": [
          "test-ui"
        ],
        "summary": "Get Chat Test Ui",
        "description": "Serve the chat test UI - a browser-based harness for end-to-end testing.\n\nFeatures:\n- JWT token authentication\n- Multi-user simulation (open multiple windows)\n- Real-time WebSocket messaging\n- RBAC permission testing\n- Message CRUD operations\n- Connection monitoring\n\nUsage:\n    1. Get JWT tokens from auth-api for different users\n    2. Open this page in multiple browser windows\n    3. Paste different tokens in each window\n    4. Connect to the same group and test messaging\n\nExample:\n    http://localhost:8001/test-chat",
        "operationId": "get_chat_test_ui_test_chat_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "text/html": {
                "schema": {
                  "type": "string"
                }
              }
            }
          }
        }
      }
    },
    "/health": {
      "get": {
        "summary": "Health Check",
        "description": "Production-grade health check endpoint.\n\nVerifies:\n- MongoDB connectivity\n- Redis connectivity (if configured)\n- Auth API connectivity (for RBAC)\n- Overall application health\n\nReturns 200 if all checks pass, 503 if any critical component fails.",
        "operationId": "health_check_health_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {}
              }
            }
          }
        }
      }
    },
    "/": {
      "get": {
        "summary": "Root",
        "description": "Root endpoint.",
        "operationId": "root__get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {}
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "HTTPValidationError": {
        "properties": {
          "detail": {
            "items": {
              "$ref": "#/components/schemas/ValidationError"
            },
            "type": "array",
            "title": "Detail"
          }
        },
        "type": "object",
        "title": "HTTPValidationError"
      },
      "MessageCreate": {
        "properties": {
          "content": {
            "type": "string",
            "maxLength": 10000,
            "minLength": 1,
            "title": "Content"
          }
        },
        "type": "object",
        "required": [
          "content"
        ],
        "title": "MessageCreate",
        "description": "Schema for creating a new message."
      },
      "MessageListResponse": {
        "properties": {
          "messages": {
            "items": {
              "$ref": "#/components/schemas/MessageResponse"
            },
            "type": "array",
            "title": "Messages"
          },
          "total": {
            "type": "integer",
            "title": "Total"
          },
          "page": {
            "type": "integer",
            "title": "Page"
          },
          "page_size": {
            "type": "integer",
            "title": "Page Size"
          },
          "has_more": {
            "type": "boolean",
            "title": "Has More"
          }
        },
        "type": "object",
        "required": [
          "messages",
          "total",
          "page",
          "page_size",
          "has_more"
        ],
        "title": "MessageListResponse",
        "description": "Schema for paginated message list."
      },
      "MessageResponse": {
        "properties": {
          "id": {
            "type": "string",
            "title": "Id"
          },
          "org_id": {
            "type": "string",
            "title": "Org Id"
          },
          "group_id": {
            "type": "string",
            "title": "Group Id"
          },
          "group_name": {
            "type": "string",
            "title": "Group Name"
          },
          "sender_id": {
            "type": "string",
            "title": "Sender Id"
          },
          "content": {
            "type": "string",
            "title": "Content"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "title": "Created At"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "title": "Updated At"
          },
          "is_deleted": {
            "type": "boolean",
            "title": "Is Deleted",
            "default": false
          }
        },
        "type": "object",
        "required": [
          "id",
          "org_id",
          "group_id",
          "group_name",
          "sender_id",
          "content",
          "created_at",
          "updated_at"
        ],
        "title": "MessageResponse",
        "description": "Schema for message response.\n\nMulti-Tenant Architecture:\n- org_id: Organization UUID for client-side filtering\n- group_id: Group UUID from Auth-API\n- group_name: Denormalized for performance (no Auth-API call needed)"
      },
      "MessageUpdate": {
        "properties": {
          "content": {
            "type": "string",
            "maxLength": 10000,
            "minLength": 1,
            "title": "Content"
          }
        },
        "type": "object",
        "required": [
          "content"
        ],
        "title": "MessageUpdate",
        "description": "Schema for updating a message."
      },
      "ValidationError": {
        "properties": {
          "loc": {
            "items": {
              "anyOf": [
                {
                  "type": "string"
                },
                {
                  "type": "integer"
                }
              ]
            },
            "type": "array",
            "title": "Location"
          },
          "msg": {
            "type": "string",
            "title": "Message"
          },
          "type": {
            "type": "string",
            "title": "Error Type"
          }
        },
        "type": "object",
        "required": [
          "loc",
          "msg",
          "type"
        ],
        "title": "ValidationError"
      }
    },
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "JWT access token from auth-api. Format: `Bearer <token>`. Token must be obtained from auth-api /auth/login endpoint."
      }
    }
  }
}
